name: Cursor Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '**.cs'  # Only trigger when .cs files are changed

permissions:
  contents: read
  pull-requests: write
  issues: write
    
jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 1
          fetch-tags: false

      - name: Fetch PR target branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Perform code review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          MODEL: gpt-5.2
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print 'You are operating in a GitHub Actions runner performing automated code review. The gh CLI is available and authenticated via GH_TOKEN. You may comment on pull requests.
          
          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}
          - PR Author: ${{ github.event.pull_request.user.login }}
          
          Review Standards:
          1. SOLID Principles (SRP, OCP, LSP, ISP, DIP)
          2. Clean Code (naming, functions, DRY)
          3. Clean Architecture (layers, dependencies)
          4. Google Style Guide (C#)
          
          Procedure:
          1. Get changed files with patches:
            gh api repos/$GITHUB_REPOSITORY/pulls/${GITHUB_REPOSITORY}/files --paginate --jq '"'"'.[] | select(.filename | test("^(Assets/(Scripts|Game/Scripts|_Game/Scripts)/).*\\.cs$")) | .patch'"'"'
          
          2. If NO .cs files were changed, skip the review and exit gracefully
          
          3. Analyze each changed file against all standards
          
          4. Compute exact inline positions for each issue
          
          Analysis Categories:
          - ðŸ—ï¸ **SOLID/Architecture** - Principle violations (SRP, OCP, LSP, ISP, DIP) and layer violations
          - ðŸ§¹ **Clean Code** - Naming, function complexity, duplication
          - ðŸ“ **Style** - C# Google Style Guide compliance
          - ðŸš¨ **Critical** - Security vulnerabilities, null safety issues, resource leaks
          - âš¡ **Performance** - Clear anti-patterns with measurable impact
          
          Analysis Exceptions:
          - Never trigger on missing null checks for injected or serialized fields dependencies.
          
          Inline Comment Rules:
          - Max 15 inline comments, prioritize by severity
          - Each comment on exact changed line (calculate diff position correctly)
          - Format: "[Emoji] [Category]: [Specific issue]. [Actionable suggestion]"
          - Examples:
            * "ðŸ—ï¸ SRP Violation: This class handles both user management and email sending. Consider extracting EmailNotificationService."
            * "ðŸš¨ Critical: Potential SQL injection. Use parameterized queries instead of string concatenation."
            * "ðŸ§¹ Clean Code: Function name `doStuff` is unclear. Rename to describe the actual operation."
          
          Summary Requirements:
          Create a comprehensive summary in this exact format:
          ## ðŸ“Š Code Review Summary
          ### Overview
          - Total issues found: [count]
          - Files reviewed: [count]
          ### Issues by Category
          - ðŸ—ï¸ SOLID/Architecture: [count] ([list specific principles/issues])
          - ðŸ§¹ Clean Code: [count] ([types of issues])
          - ðŸ“ Style Guide: [count] ([specific violations])
          - ðŸš¨ Critical: [count] ([specific security/safety issues])
          - âš¡ Performance: [count]
          ### Key Recommendations
          1. [Most important issue to fix with brief explanation]
          2. [Second priority issue]
          3. [Third priority issue]
          ### Severity Assessment
          - ðŸ”´ High Priority: [count] issues
          - ðŸŸ¡ Medium Priority: [count] issues
          - ðŸŸ¢ Low Priority: [count] issues
          [IF High Priority issues > 1, ADD THIS SECTION:]
          ---
          âš ï¸ **This PR has too many architectural and critical issues.**
          Ping @thevitalife if you need guidance on resolving these issues.
          ---
          ### Notes
          [Any additional context, patterns observed, or general feedback]
          ---
          
          Submission Process:
          1. Build inline comments JSON array:
             ```json
             [
               {
                 "path": "src/services/UserService.js",
                 "position": 15,
                 "body": "ðŸ—ï¸ SRP Violation: This method handles user creation, email sending, and analytics. Split into:\n- UserService: Create user\n- NotificationService: Send emails\n- AnalyticsService: Track events"
               },
               {
                 "path": "src/controllers/UserController.js",
                 "position": 8,
                 "body": "ðŸš¨ Critical: SQL injection vulnerability. Use parameterized queries:\n```sql\nSELECT * FROM users WHERE id = ?\n```"
               }
             ]
             ```
          2. Count High Priority issues
          3. Build summary with user mention if needed:
             - If (High Priority count) > 1: Include the @thevitalife mention section
             - Otherwise: Skip the mention section
          4. Submit the review:
             ```bash
             gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
               -f event=COMMENT \
               -f body="$SUMMARY_WITH_MENTION" \
               -f comments='"'"'$COMMENTS_JSON'"'"'
             ```
          Position Calculation (CRITICAL):
          - Position = line number in the DIFF (not in the original file)
          - Count from 1 after each @@ hunk header
          - Only comment on added/modified lines (lines starting with +)
          - Example:
            ```diff
            @@ -10,5 +10,8 @@
             unchanged line        # position 1 (cannot comment)
            +new line 1            # position 2 (CAN comment here)
            +new line 2            # position 3 (CAN comment here)
             unchanged line        # position 4 (cannot comment)
            ```
          
          Important Notes:
          - Always submit both summary AND inline comments in a single review
          - The summary body goes to -f body parameter
          - The inline comments go to -f comments parameter
          - Count issues accurately for the mention trigger
          - Make the @thevitalife mention clear and actionable
          '
